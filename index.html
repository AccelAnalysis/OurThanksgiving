<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Thanksgiving Potluck Signup</title>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;700;900&family=Playfair+Display:wght@700;800&display=swap" rel="stylesheet">

  <style>
    :root{
      --cranberry:#9c2f2f;
      --pumpkin:#f56004;
      --gold:#dbba33;
      --warm-brown:#633f21;
      --deep-brown:#2a1710;
      --cream:#fff7ea;
      --card:#ffffff;
      --text:#22130d;
      --muted:#6a564f;
      --radius:20px;
      --shadow:0 14px 36px rgba(34,19,13,.16);
      --transition:all 0.25s ease;
    }

    *{box-sizing:border-box; margin:0; padding:0;}
    body{
      font-family:'Nunito', sans-serif;
      color:var(--text);
      background:
        radial-gradient(1200px 700px at 5% -15%, #ffe8c6 0%, transparent 65%),
        radial-gradient(1000px 700px at 105% -10%, #ffe0e0 0%, transparent 65%),
        linear-gradient(#fff4de, #fff1e3);
      line-height:1.5;
    }

    .hero{
      position:relative;
      min-height:45vh;
      display:flex;
      align-items:center;
      justify-content:center;
      text-align:center;
      padding:32px 16px;
      /* CORRECTED IMAGE URL for stability */
      background:linear-gradient(to bottom, rgba(0,0,0,.45), rgba(0,0,0,.45)),
                 url("https://images.unsplash.com/photo-1543360439-d81b312781d4") center/cover no-repeat;
      color:white;
    }
    .hero-inner{
      max-width:900px;
      background:rgba(0,0,0,.3);
      backdrop-filter:blur(4px);
      border:1px solid rgba(255,255,255,.2);
      border-radius:24px;
      padding:28px 20px;
    }
    .hero h1{
      font-family:"Playfair Display", serif;
      font-size:clamp(2.2rem,6vw,3.8rem);
      margin-bottom:8px;
      font-weight:800;
    }
    .hero p{
      font-size:clamp(1.1rem,3vw,1.4rem);
      opacity:.96;
    }

    /* CORRECTED MARGIN */
    .wrap{
      max-width:1160px;
      margin:20px auto 60px; /* REMOVED NEGATIVE MARGIN */
      padding:0 16px;
      display:grid;
      gap:20px;
      grid-template-columns:1.15fr .85fr;
    }
    @media (max-width:940px){
      .wrap{grid-template-columns:1fr; margin-top:20px;} /* ADJUSTED MARGIN */
    }

    .card{
      background:var(--card);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      padding:24px;
      border:1px solid rgba(34,19,13,.07);
    }
    .card h2{
      font-family:"Playfair Display", serif;
      font-size:1.55rem;
      color:var(--deep-brown);
      margin-bottom:16px;
    }

    /* Categories & Items */
    .category{
      background:var(--cream);
      border:2px dashed rgba(99,63,33,.22);
      border-radius:16px;
      padding:16px;
      margin:16px 0;
    }
    .category h3{
      font-size:1.18rem;
      color:var(--warm-brown);
      display:flex;
      align-items:center;
      gap:10px;
      margin-bottom:12px;
    }
    .pill{
      font-size:.75rem;
      padding:4px 10px;
      background:white;
      border:1px solid rgba(99,63,33,.25);
      border-radius:99px;
      font-weight:800;
      color:var(--warm-brown);
    }
    .items{
      display:grid;
      gap:10px;
    }
    .item-row{
      display:grid;
      grid-template-columns:1fr auto;
      align-items:center;
      gap:12px;
      padding:12px 14px;
      background:white;
      border-radius:14px;
      border:1px solid rgba(99,63,33,.12);
      transition:var(--transition);
    }
    .item-row:hover{box-shadow:0 4px 12px rgba(0,0,0,.08);}
    .claimed{
      background:var(--cranberry);
      color:white;
      font-weight:800;
      font-size:.9rem; /* IMPROVED FONT SIZE */
      padding:8px 14px; /* IMPROVED PADDING */
      border-radius:99px;
    }
    .unclaimed{
      background:#fff3d6;
      color:var(--pumpkin);
      border:1px solid rgba(245,96,4,.3);
      font-weight:800;
      font-size:.9rem; /* IMPROVED FONT SIZE */
      padding:8px 14px; /* IMPROVED PADDING */
      border-radius:99px;
    }

    /* Form */
    label{
      display:block;
      font-weight:800;
      margin:14px 0 6px;
      color:var(--deep-brown);
    }
    input, select, textarea{
      width:100%;
      padding:12px 14px;
      font-size:1rem;
      border-radius:14px;
      border:1px solid rgba(34,19,13,.18);
      background:#fff;
      font-family:inherit;
      transition:var(--transition);
    }
    input:focus, select:focus, textarea:focus{
      outline:none;
      border-color:var(--pumpkin);
      box-shadow:0 0 0 4px rgba(245,96,4,.4); /* IMPROVED FOCUS RING */
    }
    textarea{min-height:80px; resize:vertical;}
    .row{
      display:grid;
      gap:12px;
      grid-template-columns:1fr 1fr;
    }
    @media (max-width:520px){.row{grid-template-columns:1fr;}}

    .btn{
      cursor:pointer;
      border:none;
      padding:14px 20px;
      font-size:1.05rem;
      font-weight:900;
      border-radius:14px;
      margin-top:12px;
      transition:var(--transition);
      background:linear-gradient(135deg,var(--pumpkin), #ff7a1a);
      color:white;
      box-shadow:0 8px 20px rgba(245,96,4,.3);
    }
    .btn:hover{transform:translateY(-2px); box-shadow:0 12px 28px rgba(245,96,4,.35);}
    .btn:disabled{
      opacity:0.6;
      cursor:not-allowed;
      transform:none;
    }
    .btn.secondary{
      background:#fff8ef;
      color:var(--warm-brown);
      border:2px solid rgba(245,96,4,.3);
      box-shadow:none;
    }

    .notice{
      margin-top:12px;
      padding:12px 14px;
      border-radius:14px;
      font-size:.95rem;
      font-weight:700;
    }
    .notice.good{background:#e6f7e6; border:1px solid #a3e0a3; color:#186b2c;}
    .notice.warn{background:#ffe6e6; border:1px solid #f0bcbc; color:#8b1a1a;}
    .loading{
      color:var(--muted);
      font-style:italic;
      text-align:center;
      padding:30px;
    }

    footer{
      text-align:center;
      padding:30px 16px;
      color:var(--muted);
      font-size:.95rem;
    }
    .spinner{
      display:inline-block;
      width:16px;
      height:16px;
      border:2px solid #fff;
      border-top-color:transparent;
      border-radius:50%;
      animation:spin 0.8s linear infinite;
      margin-right:8px;
    }
    @keyframes spin{to{transform:rotate(360deg)}}
  </style>
</head>
<body>

  <section class="hero" role="banner">
    <div class="hero-inner">
      <h1>Thanksgiving Potluck</h1>
      <p>Let‚Äôs give thanks together. Pick a dish or add your own!</p>
    </div>
  </section>

  <main class="wrap">

    <section class="card" aria-labelledby="list-title">
      <h2 id="list-title">What We‚Äôve Got So Far</h2>
      <div id="listArea" class="loading">Loading the feast...</div>
    </section>

    <section class="card" aria-labelledby="form-title">
      <h2 id="form-title">Claim Your Dish</h2>

      <p class="muted" style="margin-bottom: 20px;">
        To add a new dish, <a href="#addItemForm" style="color: var(--pumpkin); font-weight: 700;">click here</a>.
      </p>

      <form id="signupForm" novalidate>
        <label for="name">Your Name</label>
        <input id="name" type="text" required placeholder="e.g., Aunt Linda" autocomplete="name"/>

        <div class="row">
          <div>
            <label for="categorySelect">Category</label>
            <select id="categorySelect" required></select>
          </div>
          <div>
            <label for="itemSelect">Dish</label>
            <select id="itemSelect" required></select>
          </div>
        </div>

        <label for="quantity">Serving Size <span class="muted">(optional)</span></label>
        <input id="quantity" placeholder="e.g., feeds 8, 1 large tray, 2 pies"/>

        <label for="notes">Notes <span class="muted">(optional)</span></label>
        <textarea id="notes" placeholder="e.g., gluten-free, extra spicy, homemade crust"></textarea>

        <button type="submit" class="btn" id="submitBtn">
          <span class="btn-text">I‚Äôll Bring This!</span>
        </button>
        <div id="status" aria-live="polite"></div>
      </form>

      <hr style="margin:30px 0; border:none; height:1px; background:rgba(99,63,33,.15);"/>

      <h2 style="font-size:1.55rem; color:var(--pumpkin);">üçΩÔ∏è Add Your Own Dish</h2>
      <p class="muted">Don't see your favorite? Add it below!</p>

      <form id="addItemForm" novalidate>
        <div class="row">
          <div>
            <label for="addCategoryExisting">Existing Category</label>
            <select id="addCategoryExisting"><option value="">Choose or type new ‚Üí</option></select>
          </div>
          <div>
            <label for="addCategoryNew">Or New Category</label>
            <input id="addCategoryNew" placeholder="e.g., Vegan Options"/>
          </div>
        </div>

        <label for="addItemName">Dish Name</label>
        <input id="addItemName" required placeholder="e.g., Vegan Mushroom Wellington"/>

        <label for="addItemNotes">Notes <span class="muted">(optional)</span></label>
        <input id="addItemNotes" placeholder="e.g., nut-free, serves 10"/>

        <button type="submit" class="btn secondary" id="addItemBtn">Add to List</button>
        <div id="addItemStatus" aria-live="polite"></div>
      </form>
    </section>
  </main>

  <footer>
    ‚ÄúGratitude turns what we have into enough.‚Äù ‚Äî Anonymous
  </footer>

<script>
  // REPLACE THIS WITH YOUR ACTUAL GOOGLE APPS SCRIPT WEB APP URL
  const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbw8OTuljKtbFlrn67N-2Zr8WZpnSVyTAgJ-tK2pD69oMQZZMVB0O9_nGn8F_GGDVH0o/exec";   // ‚Üê PUT YOUR URL HERE

  if (SCRIPT_URL.includes("AKfycbx") || SCRIPT_URL.includes("PASTE")) {
    alert("Please paste your Google Apps Script Web App URL into the SCRIPT_URL variable!");
  }

  const listArea = document.getElementById('listArea');
  const categorySelect = document.getElementById('categorySelect');
  const itemSelect = document.getElementById('itemSelect');
  const addCategoryExisting = document.getElementById('addCategoryExisting');
  const submitBtn = document.getElementById('submitBtn');
  const addItemBtn = document.getElementById('addItemBtn');

  let dataCache = { categories: {}, signups: [] };

  function setStatus(el, msg, type = "muted") {
    el.innerHTML = `<div class="notice ${type}">${msg}</div>`;
  }
  function clearStatus(el) { el.innerHTML = ""; }

  function showLoading(btn) {
    const text = btn.querySelector('.btn-text') || btn;
    btn.disabled = true;
    text.innerHTML = '<span class="spinner"></span> Saving...';
  }
  function hideLoading(btn, text) {
    btn.disabled = false;
    const txtEl = btn.querySelector('.btn-text') || btn;
    txtEl.textContent = text;
  }

  async function fetchData() {
    try {
      const res = await fetch(`${SCRIPT_URL}?action=list`);
      if (!res.ok) throw new Error("Server error");
      const json = await res.json();
      dataCache = json;
      renderList(json);
      populateSelectors(json);
    } catch (err) {
      listArea.innerHTML = `<div class="notice warn">Could not load list. Check your internet or the script URL.</div>`;
    }
  }

  function renderList({ categories, signups }) {
    if (!categories || Object.keys(categories).length === 0) {
      listArea.innerHTML = `<div class="notice warn">No dishes yet ‚Äî be the first!</div>`;
      return;
    }

    const claimed = {};
    (signups || []).forEach(s => {
      const key = `${s.category}||${s.item}`;
      claimed[key] = claimed[key] || [];
      claimed[key].push(s.name + (s.quantity ? ` (${s.quantity})` : ""));
    });

    let html = "";
    Object.keys(categories).sort().forEach(cat => {
      const items = categories[cat] || [];
      html += `
        <div class="category">
          <h3>${cat} <span class="pill">${items.length}</span></h3>
          <ul class="items">
            ${items.map(it => {
              const key = `${cat}||${it.name}`;
              const takers = claimed[key] || [];
              const badge = takers.length
                ? `<span class="claimed">${takers.join(", ")}</span>`
                : `<span class="unclaimed">Available</span>`;
              return `
                <li class="item-row">
                  <div>
                    <strong>${it.name}</strong>
                    ${it.notes ? `<br><small>${it.notes}</small>` : ""}
                  </div>
                  ${badge}
                </li>`;
            }).join("")}
          </ul>
        </div>`;
    });
    listArea.innerHTML = html;
  }

  function populateSelectors({ categories, signups }) {
    const cats = Object.keys(categories).sort();

    const claimedMap = {};
    (signups || []).forEach(s => {
      const key = `${s.category}||${s.item}`;
      claimedMap[key] = (claimedMap[key] || 0) + 1;
    });

    // Category selects
    const catOptions = cats.map(c => `<option value="${c}">${c}</option>`).join("");
    categorySelect.innerHTML = catOptions;
    addCategoryExisting.innerHTML = `<option value="">Choose existing</option>` + catOptions;

    // Items ‚Äî show taken status
    function updateItems() {
      const cat = categorySelect.value;
      const items = categories[cat] || [];
      itemSelect.innerHTML = items.map(it => {
        const key = `${cat}||${it.name}`;
        const taken = claimedMap[key] || 0;
        const suffix = taken ? ` ‚Äî Taken${taken > 1 ? ` (${taken})` : ""}` : "";
        return `<option value="${it.name}">${it.name}${suffix}</option>`;
      }).join("") || `<option>(No items in this category)</option>`;
    }
    categorySelect.addEventListener("change", updateItems);
    updateItems();
  }

  // Signup form
  document.getElementById("signupForm").addEventListener("submit", async e => {
    e.preventDefault();
    clearStatus(document.getElementById("status"));
    showLoading(submitBtn);

    const payload = {
      action: "signup",
      name: document.getElementById("name").value.trim(),
      category: categorySelect.value,
      item: itemSelect.value,
      quantity: document.getElementById("quantity").value.trim(),
      notes: document.getElementById("notes").value.trim()
    };

    if (!payload.name || !payload.category || !payload.item) {
      setStatus(document.getElementById("status"), "Please fill name and select a dish.", "warn");
      hideLoading(submitBtn, "I‚Äôll Bring This!");
      return;
    }

    try {
      const res = await fetch(SCRIPT_URL, {
        method: "POST",
        headers: { "Content-Type": "application/x-www-form-urlencoded" },
        body: new URLSearchParams(payload)
      });
      const json = await res.json();
      if (json.ok) {
        setStatus(document.getElementById("status"), "You‚Äôre all set! Thank you!", "good");
        e.target.reset();
        await fetchData();
      } else {
        setStatus(document.getElementById("status"), json.error || "Something went wrong.", "warn");
      }
    } catch (err) {
      setStatus(document.getElementById("status"), "Connection failed. Try again.", "warn");
    } finally {
      hideLoading(submitBtn, "I‚Äôll Bring This!");
    }
  });

  // Add new item
  document.getElementById("addItemForm").addEventListener("submit", async e => {
    e.preventDefault();
    clearStatus(document.getElementById("addItemStatus"));
    addItemBtn.disabled = true;
    addItemBtn.textContent = "Adding...";

    const existingCat = addCategoryExisting.value;
    const newCat = document.getElementById("addCategoryNew").value.trim();
    const category = newCat || existingCat;
    const item = document.getElementById("addItemName").value.trim();
    const notes = document.getElementById("addItemNotes").value.trim();

    if (!category || !item) {
      setStatus(document.getElementById("addItemStatus"), "Category and dish name required.", "warn");
      addItemBtn.disabled = false;
      addItemBtn.textContent = "Add to List";
      return;
    }

    const payload = { action: "addItem", category, item, notes };
    try {
      const res = await fetch(SCRIPT_URL, {
        method: "POST",
        headers: { "Content-Type": "application/x-www-form-urlencoded" },
        body: new URLSearchParams(payload)
      });
      const json = await res.json();
      if (json.ok) {
        setStatus(document.getElementById("addItemStatus"), `"${item}" added!`, "good");
        e.target.reset();
        await fetchData();
        categorySelect.value = category;
        categorySelect.dispatchEvent(new Event("change"));
      } else {
        setStatus(document.getElementById("addItemStatus"), json.error || "Failed to add.", "warn");
      }
    } catch (err) {
      setStatus(document.getElementById("addItemStatus"), "Connection failed.", "warn");
    } finally {
      addItemBtn.disabled = false;
      addItemBtn.textContent = "Add to List";
    }
  });

  // Initial load
  fetchData();
</script>
</body>
</html>
