<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Thanksgiving PotBlessing Signup</title>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;700;900&family=Playfair+Display:wght@700;800&display=swap" rel="stylesheet">

  <style>
    :root{
      --cranberry:#9c2f2f;
      --pumpkin:#f56004;
      --gold:#dbba33;
      --warm-brown:#633f21;
      --deep-brown:#2a1710;
      --cream:#fff7ea;
      --card:#ffffff;
      --text:#22130d;
      --muted:#6a564f;
      --radius:20px;
      --shadow:0 14px 36px rgba(34,19,13,.16);
      --transition:all 0.2s ease;
      --ring:0 0 0 4px rgba(245,96,4,.25);
    }

    *{box-sizing:border-box; margin:0; padding:0;}
    body{
      font-family:'Nunito', sans-serif;
      color:var(--text);
      background:
        radial-gradient(1200px 700px at 5% -15%, #ffe8c6 0%, transparent 65%),
        radial-gradient(1000px 700px at 105% -10%, #ffe0e0 0%, transparent 65%),
        linear-gradient(#fff4de, #fff1e3);
      line-height:1.5;
    }

    .hero{
      position:relative;
      min-height:45vh;
      display:flex;
      align-items:center;
      justify-content:center;
      text-align:center;
      padding:32px 16px;
      background:linear-gradient(to bottom, rgba(0,0,0,.45), rgba(0,0,0,.45)),
                 url("https://www.bu.edu/files/2024/11/thanksgiving-dinner-feat.jpg") center/cover no-repeat;
      color:white;
    }
    .hero-inner{
      max-width:900px;
      background:rgba(0,0,0,.3);
      backdrop-filter:blur(4px);
      border:1px solid rgba(255,255,255,.2);
      border-radius:24px;
      padding:28px 20px;
    }
    .hero h1{
      font-family:"Playfair Display", serif;
      font-size:clamp(2.2rem,6vw,3.8rem);
      margin-bottom:8px;
      font-weight:800;
    }
    .hero p{
      font-size:clamp(1.1rem,3vw,1.4rem);
      opacity:.96;
    }

    .wrap{
      max-width:1160px;
      margin:20px auto 60px;
      padding:0 16px;
      display:grid;
      gap:20px;
      grid-template-columns:1.15fr .85fr;
    }
    @media (max-width:940px){
      .wrap{grid-template-columns:1fr; margin-top:20px;}
    }

    .card{
      background:var(--card);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      padding:24px;
      border:1px solid rgba(34,19,13,.07);
    }
    .card h2{
      font-family:"Playfair Display", serif;
      font-size:1.55rem;
      color:var(--deep-brown);
      margin-bottom:16px;
    }

    /* Category blocks */
    .category{
      background:var(--cream);
      border:2px dashed rgba(99,63,33,.22);
      border-radius:16px;
      padding:16px;
      margin:16px 0;
    }
    .cat-header{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      margin-bottom:12px;
    }
    .category h3{
      font-size:1.18rem;
      color:var(--warm-brown);
      display:flex;
      align-items:center;
      gap:10px;
    }
    .pill{
      font-size:.75rem;
      padding:4px 10px;
      background:white;
      border:1px solid rgba(99,63,33,.25);
      border-radius:99px;
      font-weight:800;
      color:var(--warm-brown);
    }

    .items{
      display:grid;
      gap:10px;
    }

    /* Clickable item cards */
    .item-row{
      display:grid;
      grid-template-columns:1fr auto;
      align-items:center;
      gap:12px;
      padding:12px 14px;
      background:white;
      border-radius:14px;
      border:1px solid rgba(99,63,33,.12);
      transition:var(--transition);
      cursor:pointer;
      position:relative;
    }
    .item-row:hover{box-shadow:0 4px 12px rgba(0,0,0,.08); transform:translateY(-1px);}
    .item-row.selected{
      box-shadow:var(--ring), var(--shadow);
      border-color:rgba(245,96,4,.7);
    }
    .item-row.disabled{
      cursor:not-allowed;
      opacity:.85;
    }

    .claimed{
      background:var(--cranberry);
      color:white;
      font-weight:800;
      font-size:.9rem;
      padding:8px 14px;
      border-radius:99px;
      white-space:nowrap;
    }
    .unclaimed{
      background:#fff3d6;
      color:var(--pumpkin);
      border:1px solid rgba(245,96,4,.3);
      font-weight:800;
      font-size:.9rem;
      padding:8px 14px;
      border-radius:99px;
      white-space:nowrap;
    }

    /* Add item inline row */
    .add-row{
      margin-top:10px;
      background:#fff;
      border:1px solid rgba(99,63,33,.18);
      border-radius:12px;
      padding:10px;
      display:grid;
      gap:8px;
    }
    .add-row .row{
      display:grid;
      grid-template-columns:1fr 1fr;
      gap:8px;
    }
    @media (max-width:520px){ .add-row .row{grid-template-columns:1fr;} }

    /* Buttons */
    .btn{
      cursor:pointer;
      border:none;
      padding:12px 16px;
      font-size:1rem;
      font-weight:900;
      border-radius:12px;
      transition:var(--transition);
      background:linear-gradient(135deg,var(--pumpkin), #ff7a1a);
      color:white;
      box-shadow:0 6px 16px rgba(245,96,4,.25);
    }
    .btn:hover{transform:translateY(-1px);}
    .btn:disabled{opacity:0.6; cursor:not-allowed; transform:none;}
    .btn.secondary{
      background:#fff8ef;
      color:var(--warm-brown);
      border:2px solid rgba(245,96,4,.3);
      box-shadow:none;
      font-weight:800;
    }
    .btn.tiny{
      padding:8px 12px;
      font-size:.9rem;
      box-shadow:none;
      background:#fff;
      color:var(--pumpkin);
      border:2px solid rgba(245,96,4,.35);
    }

    /* Form */
    label{
      display:block;
      font-weight:800;
      margin:14px 0 6px;
      color:var(--deep-brown);
    }
    input, textarea{
      width:100%;
      padding:12px 14px;
      font-size:1rem;
      border-radius:14px;
      border:1px solid rgba(34,19,13,.18);
      background:#fff;
      font-family:inherit;
      transition:var(--transition);
    }
    input:focus, textarea:focus{
      outline:none;
      border-color:var(--pumpkin);
      box-shadow:0 0 0 4px rgba(245,96,4,.25);
    }
    textarea{min-height:80px; resize:vertical;}

    .selected-chip{
      display:inline-flex;
      align-items:center;
      gap:8px;
      background:var(--cream);
      border:1px dashed rgba(99,63,33,.35);
      padding:8px 10px;
      border-radius:12px;
      font-weight:900;
      color:var(--warm-brown);
      margin-bottom:8px;
    }
    .selected-chip small{
      font-weight:700;
      color:var(--muted);
    }

    .notice{
      margin-top:12px;
      padding:12px 14px;
      border-radius:14px;
      font-size:.95rem;
      font-weight:700;
    }
    .notice.good{background:#e6f7e6; border:1px solid #a3e0a3; color:#186b2c;}
    .notice.warn{background:#ffe6e6; border:1px solid #f0bcbc; color:#8b1a1a;}
    .loading{
      color:var(--muted);
      font-style:italic;
      text-align:center;
      padding:30px;
    }

    footer{
      text-align:center;
      padding:30px 16px;
      color:var(--muted);
      font-size:.95rem;
    }

    .muted{color:var(--muted); font-weight:700;}
  </style>
</head>
<body>

  <section class="hero" role="banner">
    <div class="hero-inner">
      <h1>Thanksgiving PotBlessing!</h1>
      <p>Click a dish you want to bring, or add a new one for the list.</p>
      <h3>Serving 20 to 25 Poeple, including Children</h3>
    </div>
  </section>

  <main class="wrap">

    <!-- LEFT: LIST -->
    <section class="card" aria-labelledby="list-title">
      <h2 id="list-title">What Weâ€™ve Got So Far ...and Some Suggestions</h2>
      <div id="listArea" class="loading">Loading the feast...</div>
    </section>

    <!-- RIGHT: CLAIM FORM -->
    <section class="card" aria-labelledby="form-title" id="claimCard">
      <h2 id="form-title">Bring This Dish</h2>

      <div id="selectedInfo" class="notice muted" style="background:#fff;">
        Click an <strong>Available</strong> dish on the left to claim it.
      </div>

      <form id="claimForm" novalidate>
        <label for="name">Your Name</label>
        <input id="name" type="text" required placeholder="e.g., Aunt Bea" autocomplete="name"/>

        <label for="quantity">Serving Size <span class="muted">(optional)</span></label>
        <input id="quantity" placeholder="e.g., feeds 8, 1 large tray, 2 pies"/>

        <label for="notes">Notes <span class="muted">(optional)</span></label>
        <textarea id="notes" placeholder="e.g., gluten-free, extra spicy, homemade crust"></textarea>

        <button type="submit" class="btn" id="claimBtn" disabled>
          Iâ€™ll Bring This!
        </button>
        <div id="status" aria-live="polite"></div>
      </form>
    </section>
  </main>

  <footer>
    "O give thanks unto the LORD for He is Good." â€“ Psalm 107:1
  </footer>

<script>
  // REPLACE WITH YOUR APPS SCRIPT WEB APP URL
  const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbw8OTuljKtbFlrn67N-2Zr8WZpnSVyTAgJ-tK2pD69oMQZZMVB0O9_nGn8F_GGDVH0o/exec";

  const listArea = document.getElementById('listArea');
  const claimForm = document.getElementById('claimForm');
  const claimBtn = document.getElementById('claimBtn');
  const statusEl = document.getElementById('status');
  const selectedInfo = document.getElementById('selectedInfo');

  let dataCache = { categories:{}, signups:[] };
  let selected = null; // {category, item, isClaimed, claimedBy[]}

  function setStatus(el, msg, type="muted"){
    el.innerHTML = `<div class="notice ${type}">${msg}</div>`;
  }
  function clearStatus(el){ el.innerHTML = ""; }

  async function fetchData(){
    try{
      const res = await fetch(`${SCRIPT_URL}?action=list`);
      if(!res.ok) throw new Error("Server error");
      dataCache = await res.json();
      renderList(dataCache);
      // try to re-highlight selected after refresh
      if(selected){
        const key = `${selected.category}||${selected.item}`;
        highlightSelectedByKey(key);
        hydrateSelectedFromCache(key);
        renderSelectedPanel();
      }
    }catch(err){
      listArea.innerHTML = `<div class="notice warn">Could not load list. Check SCRIPT_URL.</div>`;
    }
  }

  function buildClaimedMap(signups){
    const map = {};
    (signups||[]).forEach(s=>{
      const key = `${s.category}||${s.item}`;
      map[key] = map[key] || [];
      map[key].push({
        name:s.name,
        quantity:s.quantity || "",
        notes:s.notes || ""
      });
    });
    return map;
  }

  function renderList({categories, signups}){
    if(!categories || Object.keys(categories).length===0){
      listArea.innerHTML = `<div class="notice warn">No dishes yet â€” add the first one!</div>`;
      return;
    }

    const claimedMap = buildClaimedMap(signups);

    let html = "";
    Object.keys(categories).sort().forEach(cat=>{
      const items = categories[cat] || [];

      html += `
        <div class="category" data-category="${escapeHtml(cat)}">
          <div class="cat-header">
            <h3>${escapeHtml(cat)} <span class="pill">${items.length}</span></h3>
            <button class="btn tiny addItemToggle" type="button" data-category="${escapeHtml(cat)}">+ Add Item</button>
          </div>

          <div class="items">
            ${items.map(it=>{
              const key = `${cat}||${it.name}`;
              const takers = claimedMap[key] || [];
              const isClaimed = takers.length>0;

              const badge = isClaimed
                ? `<span class="claimed">${takers.map(t=>t.name).join(", ")}</span>`
                : `<span class="unclaimed">Available</span>`;

              return `
                <div class="item-row ${isClaimed ? "disabled" : ""}"
                     role="button"
                     tabindex="0"
                     data-key="${escapeHtml(key)}"
                     data-category="${escapeHtml(cat)}"
                     data-item="${escapeHtml(it.name)}">
                  <div>
                    <strong>${escapeHtml(it.name)}</strong>
                    ${it.notes ? `<br><small>${escapeHtml(it.notes)}</small>` : ""}
                  </div>
                  ${badge}
                </div>
              `;
            }).join("")}
          </div>

          <div class="add-row" id="addRow-${safeId(cat)}" style="display:none;">
            <div class="row">
              <input id="newItemName-${safeId(cat)}" placeholder="New dish name (e.g., mashed potatoes)"/>
              <input id="newItemNotes-${safeId(cat)}" placeholder="Notes (optional)"/>
            </div>
            <button class="btn secondary saveNewItem"
                    type="button"
                    data-category="${escapeHtml(cat)}">
              Add to list
            </button>
            <div class="addStatus" id="addStatus-${safeId(cat)}"></div>
          </div>
        </div>
      `;
    });

    listArea.innerHTML = html;

    // Wire clicks
    listArea.querySelectorAll(".item-row").forEach(card=>{
      card.addEventListener("click", ()=>onItemClick(card));
      card.addEventListener("keypress", (e)=>{ if(e.key==="Enter") onItemClick(card); });
    });

    listArea.querySelectorAll(".addItemToggle").forEach(btn=>{
      btn.addEventListener("click", ()=>toggleAddRow(btn.dataset.category));
    });

    listArea.querySelectorAll(".saveNewItem").forEach(btn=>{
      btn.addEventListener("click", ()=>saveNewItem(btn.dataset.category));
    });
  }

  function onItemClick(card){
    const key = card.dataset.key;
    const isDisabled = card.classList.contains("disabled");
    if(isDisabled){
      // show who claimed it
      selected = {
        category: card.dataset.category,
        item: card.dataset.item,
        isClaimed: true
      };
      hydrateSelectedFromCache(key);
      highlightSelectedByKey(key);
      renderSelectedPanel(true);
      scrollToClaim();
      return;
    }

    selected = {
      category: card.dataset.category,
      item: card.dataset.item,
      isClaimed: false
    };
    hydrateSelectedFromCache(key);
    highlightSelectedByKey(key);
    renderSelectedPanel();
    scrollToClaim();
  }

  function hydrateSelectedFromCache(key){
    const claimedMap = buildClaimedMap(dataCache.signups);
    const takers = claimedMap[key] || [];
    if(selected){
      selected.claimedBy = takers;
      selected.isClaimed = takers.length>0;
    }
  }

  function highlightSelectedByKey(key){
    listArea.querySelectorAll(".item-row").forEach(r=>r.classList.remove("selected"));
    const el = listArea.querySelector(`.item-row[data-key="${cssEscape(key)}"]`);
    if(el) el.classList.add("selected");
  }

  function renderSelectedPanel(showClaimedOnly=false){
    clearStatus(statusEl);

    if(!selected){
      selectedInfo.className = "notice muted";
      selectedInfo.style.background="#fff";
      selectedInfo.innerHTML = `Click an <strong>Available</strong> dish on the left to claim it.`;
      claimBtn.disabled = true;
      return;
    }

    const chip = `
      <div class="selected-chip">
        <span>${escapeHtml(selected.category)}:</span>
        <span>${escapeHtml(selected.item)}</span>
      </div>
    `;

    if(selected.isClaimed){
      const who = (selected.claimedBy||[]).map(t=>{
        const extras = [];
        if(t.quantity) extras.push(t.quantity);
        if(t.notes) extras.push(t.notes);
        return `<li><strong>${escapeHtml(t.name)}</strong>${extras.length?` â€” <small>${escapeHtml(extras.join(" | "))}</small>`:""}</li>`;
      }).join("");

      selectedInfo.className = "notice warn";
      selectedInfo.innerHTML = `
        ${chip}
        <div>This dish is already claimed:</div>
        <ul style="margin:6px 0 0 18px;">${who || "<li>Someone</li>"}</ul>
      `;
      claimBtn.disabled = true;
      return;
    }

    selectedInfo.className = "notice good";
    selectedInfo.innerHTML = `
      ${chip}
      <div>This one is still open. Add your name and claim it ðŸ˜„</div>
    `;
    claimBtn.disabled = false;
  }

  function scrollToClaim(){
    document.getElementById("claimCard").scrollIntoView({behavior:"smooth", block:"start"});
  }

  function toggleAddRow(category){
    const row = document.getElementById(`addRow-${safeId(category)}`);
    if(!row) return;
    row.style.display = row.style.display==="none" ? "grid" : "none";
  }

  async function saveNewItem(category){
    const nameInput = document.getElementById(`newItemName-${safeId(category)}`);
    const notesInput = document.getElementById(`newItemNotes-${safeId(category)}`);
    const addStatus = document.getElementById(`addStatus-${safeId(category)}`);

    const itemName = (nameInput.value||"").trim();
    const itemNotes = (notesInput.value||"").trim();

    addStatus.innerHTML = "";
    if(!itemName){
      setStatus(addStatus, "Please type a dish name.", "warn");
      return;
    }

    const payload = { action:"addItem", category, item:itemName, notes:itemNotes };

    try{
      setStatus(addStatus, "Addingâ€¦", "muted");
      const res = await fetch(SCRIPT_URL, {
        method:"POST",
        headers:{ "Content-Type":"application/x-www-form-urlencoded" },
        body:new URLSearchParams(payload)
      });
      const json = await res.json();
      if(!json.ok){
        setStatus(addStatus, json.error || "Couldnâ€™t add item.", "warn");
        return;
      }

      // refresh list, then auto-select new item and enable claim
      await fetchData();

      const key = `${category}||${itemName}`;
      selected = { category, item:itemName, isClaimed:false };
      hydrateSelectedFromCache(key);
      highlightSelectedByKey(key);
      renderSelectedPanel();
      scrollToClaim();

      // clear & collapse add row
      nameInput.value = "";
      notesInput.value = "";
      const row = document.getElementById(`addRow-${safeId(category)}`);
      if(row) row.style.display="none";

    }catch(err){
      setStatus(addStatus, "Connection failed. Check SCRIPT_URL.", "warn");
    }
  }

  // Claim submit
  claimForm.addEventListener("submit", async (e)=>{
    e.preventDefault();
    clearStatus(statusEl);

    if(!selected || selected.isClaimed){
      setStatus(statusEl, "Select an available dish first.", "warn");
      return;
    }

    const payload = {
      action:"signup",
      name: document.getElementById("name").value.trim(),
      category: selected.category,
      item: selected.item,
      quantity: document.getElementById("quantity").value.trim(),
      notes: document.getElementById("notes").value.trim()
    };

    if(!payload.name){
      setStatus(statusEl, "Please enter your name.", "warn");
      return;
    }

    claimBtn.disabled = true;
    claimBtn.textContent = "Savingâ€¦";

    try{
      const res = await fetch(SCRIPT_URL, {
        method:"POST",
        headers:{ "Content-Type":"application/x-www-form-urlencoded" },
        body:new URLSearchParams(payload)
      });
      const json = await res.json();
      if(json.ok){
        setStatus(statusEl, "Youâ€™re all set! Thank you ðŸ™Œ", "good");
        claimForm.reset();
        await fetchData();
      }else{
        setStatus(statusEl, json.error || "Something went wrong.", "warn");
      }
    }catch(err){
      setStatus(statusEl, "Connection failed. Try again.", "warn");
    }finally{
      claimBtn.textContent = "Iâ€™ll Bring This!";
      // re-render selection based on latest cache
      if(selected){
        const key = `${selected.category}||${selected.item}`;
        hydrateSelectedFromCache(key);
        renderSelectedPanel();
      }
    }
  });

  // Helpers
  function escapeHtml(str){
    return String(str).replace(/[&<>"']/g, s => ({
      "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"
    }[s]));
  }
  function safeId(str){
    return String(str).toLowerCase().replace(/[^a-z0-9]+/g,"-");
  }
  function cssEscape(str){
    // minimal CSS escape for attribute selector use
    return String(str).replace(/"/g, '\\"');
  }

  // Boot
  fetchData();
</script>

</body>
</html>
